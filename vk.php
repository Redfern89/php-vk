<?php
	/*
		–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ
		
		@author: Redfern89
		@date: 11.12.2023 9:50
		@packages php, php-curl, cron
		
		–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è access_token, –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–≤–æ–µ–≥–æ –ø–∞–±–ª–∏–∫–∞ -> –†–∞–±–æ—Ç–∞ —Å API -> –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á"
		–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞ - –∫–æ–ø–∏—Ä—É–µ–º –µ–≥–æ –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ. –î–∞–ª–µ–µ –Ω—É–∂–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–µ—Ä–µ–π—Ç–∏ –≤ 
		–°–æ–æ–±—â–µ–Ω–∏—è -> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±–æ—Ç–∞ -> –§–ª–∞–∂–æ–∫ "–†–∞–∑—Ä–µ—à–∞—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –≤ —á–∞—Ç—ã". –ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–∞–±–ª–∏–∫–∞
		–ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–¥–æ–±–∞–≤–∏—Ç—å –≤ —á–∞—Ç". –î–æ–±–∞–≤–ª—è–µ–º, –¥–µ–ª–∞–µ–º –±–æ—Ç–∞ –∞–¥–º–∏–Ω–æ–º! –≠—Ç–æ –≤–∞–∂–Ω–æ! –ò–Ω–∞—á–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç—å—Å—è –Ω–∞–π—Ç–∏ peer_id
		
		–ü–æ—Å–ª–µ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω—ã—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π –ø–æ–º–µ—â–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≤ –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å –∫–∞—Ç–∞–ª–æ–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä /home/$USER/vk.php), –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å
		$ php vk.php list_peers
		
		–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –ø–æ–ª—É—á–∏–º –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫–æ–π –≤—ã–≤–æ–¥ 
		
		Propbing id: 2000000000
		Propbing id: 2000000001
		Propbing id: 2000000002
		........
		Propbing id: 2000000020


		-----------------------------------------------------
		Name: –¢–ï—Å—Ç–æ–≤–∞—è –±–µ—Å–µ–¥–∞, peer_id: 2000000001
		Name: –û—Ç—Ä—è–¥ –§–ª–µ–∫—Å–∏–∫–∏, peer_id: 2000000004
		Name: —Ç–µ—Å—Ç–æ–≤—ã–π —á–∞—Ç üí©, peer_id: 2000000007
		-----------------------------------------------------
		
		–ò–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –Ω–∞—Å peer_id –∫–æ–ø–∏—Ä—É–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ. –î–∞–ª–µ–µ, –≤—ã–ø–æ–ª–Ω—è–µ–º
		$ crontab -e
		
		–¥–æ–±–∞–≤–ª—è–µ–º —Ç—É–¥–∞ —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü ($USER –º–µ–Ω—è–µ–º –Ω–∞ –∏–º—è –Ω–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ linux):
		* * * * * /home/$USER/vk.php send_message
		
		–°–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
		
	*/
	header ('Content-Type: text/plain');
	
	define ('ACCESS_TOKEN', '');		// access_token, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–≤–æ–µ–≥–æ –ø–±–ª–∏–∫–∞
	define ('PEER_PROBE_START', 0);		// –ß–∏—Å–ª–æ, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ—Ç –∏–¥—Ç–∏ –æ—Ç—Å—á–µ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–∞—Ç–æ–≤
	define ('PEER_PROBE_END', 20);		// –ß–∏—Å–ª–æ, –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ—Ç –∏–¥—Ç–∏ –æ—Ç—Å—á–µ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–∞—Ç–æ–≤
	define ('PEER_ID', '');			// –°—é–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–º–µ—Å—Ç–∏—Ç—å ID, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –ø–æ–ª—É—á–∏—à—å –∏–∑ —Å–ø–∏—Å–∫–∞ —Å –∑–∞–ø—É—Å–∫–æ–º list_peers

	// –ü—Ä–∏–Ω–∏–º–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
	$argv = $_SERVER['argv'];
	// –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞
	$current_date = date('H:i');

	/*
		–ú–∞—Å—Å–∏–≤ —Å –¥–∞—Ç–∞–º–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –≤—Ä–µ–º—è - —Å–æ–æ–±—â–µ–Ω–∏–µ
		
		
		'10:01' => '–ü—Ä–∏–≤–µ—Ç, —É–∂–µ 10:00, —à–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ',
		'10:02' => '–ë–ª—è, —É–∂–µ 10:02',
		'10:05' => '–ü–∏–¥—Ä–∏–ª–∞! –£–∂–µ 10:05!!!!111!! üí©'
		......
		'21:00' => '–£–∂–µ 21:00'
	*/
	$messages_array = array(
	
	);
	
	// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å VK API
	function _vkApi_Call($method, $params = []) {
		$params['v'] = '5.131'; // –í–µ—Ä—Å–∏—è 5.131
		$params['access_token'] = ACCESS_TOKEN; // –ü–µ—Ä–µ–¥–∞—á–∞ access_token
		$url = sprintf('https://api.vk.com/method/%s', $method); // URL –¥–ª—è –æ—Ç—Å—ã–ª–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –í–ö

		$ch = curl_init(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); // –ì–æ–≤–æ—Ä–∏–º, —á—Ç–æ-–±—ã –≤—ã–≤–æ–¥ curl –±—ã–ª –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
		curl_setopt($ch, CURLOPT_URL, $url); // –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π URL
		$params = http_build_query($params); // –°–æ–±–∏—Ä–∞–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Å—Ç—Ä–æ–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤
		curl_setopt($ch, CURLOPT_POST, true); // –ì–æ–≤–æ—Ä–∏–º, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ –æ—Ç–æ—Å–ª–∞—Ç—å POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
		curl_setopt($ch, CURLOPT_POSTFIELDS, $params); // –£–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ POST-–∑–∞–ø—Ä–æ—Å–∞
		$data = curl_exec($ch); // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
		curl_close($ch); // –ó–∞–∫—Ä—ã–≤–∞–µ–º cUrl
		
		return $data; // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
	}
	
	// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞ –æ—Ç 0 –¥–æ 4294967295
	function random_uint32_t() {
		// –ó–Ω–∞—é, –ø–æ-–∏–¥–∏–æ—Ç—Å–∫–∏, –Ω–æ —É–º–Ω–µ–µ –ª–µ–Ω—å –±—ã–ª–æ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å
		return (int)sprintf('%010d', mt_rand(0, 4294967295));
	}
	
	// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
	function _vkApi_sendMessage($peer_id, $text) {
		$vk = _vkApi_Call('messages.send', array(
			'peer_id' => $peer_id,
			'random_id' => random_uint32_t(),
			'message' => $text
		));
		
		return $vk;
	}

	// –°–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏—Ö –∫–æ–Ω—Å–æ–ª–∏
	if (isset($argv[1])) { // –ï—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç —Å –∏–Ω–¥–µ–∫—Å–æ–º 1, —Ç–æ ...
		$act_arg = $argv[1];
		
		// –ï—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç –Ω–∞–º –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - ...
		if ($act_arg == 'send_message') {
			if (!empty($messages_array)) { // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ $messages_array –Ω–µ –ø—É—Å—Ç - ...
				foreach ($messages_array as $date => $message) { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –µ–≥–æ
					if ($date == $current_date) { // –ï—Å–ª–∏ –Ω–∞—à–ª–∞—Å—å –¥–∞—Ç–∞ –∏ –æ–Ω–∞ —Å–æ–≤–ø–∞–ª–∞ —Å —Ç–µ–∫—É—â–µ–π, ...
						_vkApi_sendMessage(PEER_ID, $message); // –û—Ç—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞
					}
				}
			}
		}

		// –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∏—Ä–æ–≤, ...
		if ($act_arg == 'list_peers') {
			$peers = array();
			echo "\n";
			
			// –ü—Ä–æ–±–µ–≥–∞–µ–º—è –æ—Ç PEER_PROBE_START –¥–æ PEER_PROBE_END
			for ($i = PEER_PROBE_START; $i <= PEER_PROBE_END; $i++) {
				$peer_id = 2000000000 + $i; // peer_id –≤ —Ñ–æ–º–∞—Ç–µ 2000000000 + —Ç–µ–∫—É—â–∏–π ID
				
				echo sprintf("Probing id: %d\n", $peer_id);
				
				// –î–µ–ª–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
				$vk = _vkApi_Call('messages.getConversationsById', array('peer_ids' => $peer_id));
				$vk = json_decode($vk);
				
				// –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞—à–ª–æ—Å—å —Ç–æ, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ - ...
				if (isset($vk -> response -> items[0] -> peer)) { // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –º–∞—Å—Å–∏–≤
					$item = $vk -> response -> items[0]; 
					$peers[] = sprintf("Name: %s, peer_id: %d", $item -> chat_settings -> title, $item -> peer -> id);
				}
			}
			echo "\n\n-----------------------------------------------------\n";
			echo implode("\n", $peers); // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –æ—Ç–≤–µ—Ç
			echo "\n-----------------------------------------------------\n\n";
		}
	}

?>
